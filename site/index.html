<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>BMLT Meeting Explorer</title>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        
        body { 
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
            line-height: 1.6; 
            color: #333; 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
        }
        
        .app-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
            background: rgba(255,255,255,0.95);
            min-height: 100vh;
            backdrop-filter: blur(10px);
        }
        
        .header { 
            text-align: center;
            padding: 40px 0;
            margin-bottom: 40px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            border-radius: 20px;
            color: white;
            box-shadow: 0 10px 30px rgba(0,0,0,0.2);
        }
        .header h1 { font-size: 3em; margin-bottom: 10px; }
        .header p { font-size: 1.2em; opacity: 0.9; }
        
        .loading-screen {
            position: fixed;
            top: 0; left: 0; right: 0; bottom: 0;
            background: rgba(255,255,255,0.95);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 1000;
        }
        .loading-spinner {
            width: 60px; height: 60px;
            border: 4px solid #f3f3f3;
            border-top: 4px solid #667eea;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 20px;
        }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
        
        .progress-bar {
            width: 300px;
            height: 20px;
            background: #f0f0f0;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
        }
        .progress-fill {
            height: 100%;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            width: 0%;
            transition: width 0.3s ease;
        }
        
        .stats-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(280px, 1fr)); 
            gap: 20px; 
            margin-bottom: 40px; 
        }
        .stat-card { 
            background: white; 
            padding: 25px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            border-left: 5px solid #667eea;
            transition: transform 0.3s ease;
        }
        .stat-card:hover { transform: translateY(-5px); }
        .stat-card h3 { color: #333; margin-bottom: 15px; font-size: 1.1em; }
        .stat-number { font-size: 2.5em; font-weight: bold; color: #667eea; }
        .stat-list { list-style: none; }
        .stat-list li { 
            padding: 8px 0; 
            border-bottom: 1px solid #eee; 
            display: flex; 
            justify-content: space-between; 
        }
        .stat-list li:last-child { border-bottom: none; }
        
        .section { 
            background: white; 
            margin-bottom: 30px; 
            border-radius: 15px; 
            box-shadow: 0 5px 20px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        .section-header { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 20px 25px;
            font-size: 1.3em;
            font-weight: 600;
        }
        .section-content { padding: 25px; }
        
        .search-grid { 
            display: grid; 
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr)); 
            gap: 20px; 
            margin-bottom: 20px; 
        }
        .form-group label { 
            display: block; 
            margin-bottom: 8px; 
            font-weight: 600; 
            color: #555;
        }
        .form-group input, .form-group select { 
            width: 100%; 
            padding: 12px 15px; 
            border: 2px solid #e1e5e9; 
            border-radius: 10px; 
            font-size: 14px;
            transition: border-color 0.3s ease;
        }
        .form-group input:focus, .form-group select:focus {
            border-color: #667eea;
            outline: none;
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }
        
        .btn { 
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white; 
            padding: 12px 25px; 
            border: none; 
            border-radius: 10px; 
            cursor: pointer; 
            font-size: 14px;
            font-weight: 600;
            transition: all 0.3s ease;
            text-decoration: none;
            display: inline-block;
            text-align: center;
        }
        .btn:hover { 
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(102, 126, 234, 0.3);
        }
        .btn-secondary { 
            background: linear-gradient(135deg, #95a5a6 0%, #7f8c8d 100%);
        }
        .btn-small { padding: 8px 16px; font-size: 12px; }
        
        .query-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(350px, 1fr));
            gap: 20px;
        }
        .query-card { 
            background: #f8f9fa; 
            padding: 25px; 
            border-radius: 15px; 
            border-left: 5px solid #667eea;
            transition: all 0.3s ease;
        }
        .query-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 8px 25px rgba(0,0,0,0.15);
        }
        .query-card h4 { color: #333; margin-bottom: 10px; font-size: 1.2em; }
        .query-card p { color: #666; margin-bottom: 20px; line-height: 1.5; }
        .query-actions { display: flex; gap: 10px; flex-wrap: wrap; }
        
        .sql-editor { 
            width: 100%; 
            height: 200px; 
            font-family: 'SF Mono', 'Monaco', 'Cascadia Code', 'Courier New', monospace; 
            padding: 20px; 
            border: 2px solid #e1e5e9; 
            border-radius: 10px; 
            font-size: 14px;
            resize: vertical;
            line-height: 1.5;
        }
        .sql-editor:focus { border-color: #667eea; outline: none; }
        
        .results { margin-top: 30px; }
        .table-container { 
            overflow-x: auto; 
            background: white; 
            border-radius: 10px; 
            box-shadow: 0 3px 15px rgba(0,0,0,0.1);
            max-height: 600px;
            overflow-y: auto;
        }
        table { 
            width: 100%; 
            border-collapse: collapse; 
            font-size: 14px;
        }
        th, td { 
            padding: 15px 12px; 
            text-align: left; 
            border-bottom: 1px solid #eee; 
        }
        th { 
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            font-weight: 600; 
            color: #333;
            position: sticky;
            top: 0;
            z-index: 10;
        }
        tr:hover { background: #f8f9fa; }
        
        .alert { 
            padding: 15px 20px; 
            border-radius: 10px; 
            margin: 15px 0; 
            font-weight: 500;
        }
        .alert-error { 
            background: #fee; 
            color: #c53030; 
            border-left: 4px solid #e53e3e;
        }
        .alert-success { 
            background: #f0fff4; 
            color: #2f855a; 
            border-left: 4px solid #38a169;
        }
        .alert-info { 
            background: #e6f3ff; 
            color: #2b6cb0; 
            border-left: 4px solid #3182ce;
        }
        
        @media (max-width: 768px) {
            .app-container { padding: 10px; }
            .header h1 { font-size: 2em; }
            .search-grid { grid-template-columns: 1fr; }
            .query-actions { flex-direction: column; }
            .stats-grid { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="loading" class="loading-screen">
        <div class="loading-spinner"></div>
        <h2 id="loading-title">Loading BMLT Meeting Database...</h2>
        <div class="progress-bar">
            <div class="progress-fill" id="progress-fill"></div>
        </div>
        <p id="loading-status">Initializing SQL.js...</p>
    </div>

    <div class="app-container" id="app" style="display: none;">

        <!-- Dashboard -->
        <div id="dashboard">

            <!-- Custom SQL -->
            <div class="section">
                <div class="section-header">
                    <h2>⚡ Aggregator Custom SQL Query</h2>
                </div>
                <div class="section-content">
                    <textarea id="custom-sql" class="sql-editor" placeholder="SELECT meeting_name, location_municipality, start_time 
FROM meetings 
WHERE location_province = 'CA' 
ORDER BY start_time 
LIMIT 10;"></textarea>
                    <br><br>
                    <button class="btn" onclick="runCustomSQL()">Execute Query</button>
                    <button class="btn btn-secondary" onclick="clearSQL()">Clear</button>
                    <button class="btn btn-secondary" onclick="insertExample()">Insert Example</button>
                </div>
            </div>

            <!-- Results -->
            <div id="results" class="results" style="display: none;">
                <div class="section">
                    <div class="section-header">
                        <h2 id="results-title">Query Results</h2>
                    </div>
                    <div class="section-content">
                        <div id="results-content"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- SQL.js Library -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/sql-wasm.js"></script>
    
    <script>
        let db = null;
        
        // SQL Query Templates
        const sqlQueries = {
            'top-names': `SELECT 
    TRIM(LOWER(meeting_name)) as normalized_name,
    meeting_name as sample_name,
    COUNT(*) as count 
FROM meetings 
WHERE meeting_name IS NOT NULL AND meeting_name != ''
GROUP BY TRIM(LOWER(meeting_name)) 
ORDER BY count DESC 
LIMIT 10`,

            'virtual': `SELECT meeting_name, start_time, weekday_tinyint,
    virtual_meeting_link, virtual_meeting_additional_info,
    location_municipality, location_province
FROM meetings 
WHERE venue_type = 2 
ORDER BY weekday_tinyint, start_time
LIMIT 100`,

            'by-state': `SELECT location_province, COUNT(*) as meeting_count
FROM meetings 
WHERE location_province != '' AND location_province IS NOT NULL
GROUP BY location_province 
ORDER BY meeting_count DESC`,

            'morning': `SELECT meeting_name, start_time, weekday_tinyint,
    location_municipality, location_province, venue_type
FROM meetings 
WHERE start_time < '09:00:00' 
ORDER BY start_time
LIMIT 100`,

            'weekend': `SELECT meeting_name, start_time, weekday_tinyint,
    location_municipality, location_province, venue_type
FROM meetings 
WHERE weekday_tinyint IN (1, 7)
ORDER BY weekday_tinyint, start_time
LIMIT 100`,

            'formats': `SELECT formats, COUNT(*) as count
FROM meetings 
WHERE formats != '' AND formats IS NOT NULL
GROUP BY formats 
ORDER BY count DESC
LIMIT 20`
        };

        // Initialize the app
        async function initApp() {
            try {
                updateLoadingStatus("Loading SQL.js...", 10);
                
                // Initialize SQL.js
                const initSqlJs = window.initSqlJs;
                const SQL = await initSqlJs({
                    locateFile: file => `https://cdnjs.cloudflare.com/ajax/libs/sql.js/1.8.0/${file}`
                });

                updateLoadingStatus("Downloading database...", 30);

                // Load the SQLite database
                const response = await fetch('https://cdn.aws.bmlt.app/aggregator.db');
                if (!response.ok) {
                    throw new Error(`Failed to load database: ${response.statusText}`);
                }

                const arrayBuffer = await response.arrayBuffer();
                updateLoadingStatus("Loading database...", 80);

                db = new SQL.Database(new Uint8Array(arrayBuffer));
                
                updateLoadingStatus("Initializing dashboard...", 90);
                
                // Load dashboard stats
                loadDashboardStats();
                
                updateLoadingStatus("Ready!", 100);
                
                // Hide loading screen and show app
                setTimeout(() => {
                    document.getElementById('loading').style.display = 'none';
                    document.getElementById('app').style.display = 'block';
                }, 500);

            } catch (error) {
                console.error('Failed to initialize app:', error);
                document.getElementById('loading-status').innerHTML = `
                    <div class="alert alert-error">
                        ❌ Failed to load: ${error.message}<br><br>
                        Make sure <code>bmlt_meetings.db</code> is in the same directory as this HTML file.
                    </div>
                `;
            }
        }

        function updateLoadingStatus(message, progress) {
            document.getElementById('loading-status').textContent = message;
            document.getElementById('progress-fill').style.width = progress + '%';
        }

        function loadDashboardStats() {
            try {
                // Total meetings
                const totalResult = db.exec("SELECT COUNT(*) as count FROM meetings");
                const totalMeetings = totalResult[0]?.values[0][0] || 0;
                document.getElementById('total-meetings').textContent = totalMeetings.toLocaleString();

                // Venue types
                const venueResult = db.exec(`
                    SELECT venue_type, COUNT(*) as count 
                    FROM meetings 
                    WHERE venue_type IS NOT NULL
                    GROUP BY venue_type
                `);
                
                const venueStats = document.getElementById('venue-stats');
                venueStats.innerHTML = '';
                
                if (venueResult[0]) {
                    const venueMap = {1: "In-Person", 2: "Virtual", 3: "Hybrid"};
                    venueResult[0].values.forEach(([type, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${venueMap[type] || 'Unknown'}</span> <strong>${count.toLocaleString()}</strong>`;
                        venueStats.appendChild(li);
                    });
                }

                // Days of week
                const dayResult = db.exec(`
                    SELECT weekday_tinyint, COUNT(*) as count 
                    FROM meetings 
                    WHERE weekday_tinyint IS NOT NULL
                    GROUP BY weekday_tinyint
                    ORDER BY weekday_tinyint
                `);
                
                const dayStats = document.getElementById('day-stats');
                dayStats.innerHTML = '';
                
                if (dayResult[0]) {
                    const dayMap = {1: "Sunday", 2: "Monday", 3: "Tuesday", 4: "Wednesday", 5: "Thursday", 6: "Friday", 7: "Saturday"};
                    dayResult[0].values.forEach(([day, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${dayMap[day] || 'Unknown'}</span> <strong>${count.toLocaleString()}</strong>`;
                        dayStats.appendChild(li);
                    });
                }

                // Top regions
                const regionResult = db.exec(`
                    SELECT location_province, COUNT(*) as count 
                    FROM meetings 
                    WHERE location_province != '' AND location_province IS NOT NULL
                    GROUP BY location_province 
                    ORDER BY count DESC 
                    LIMIT 5
                `);
                
                const regionStats = document.getElementById('region-stats');
                regionStats.innerHTML = '';
                
                if (regionResult[0]) {
                    regionResult[0].values.forEach(([region, count]) => {
                        const li = document.createElement('li');
                        li.innerHTML = `<span>${region}</span> <strong>${count.toLocaleString()}</strong>`;
                        regionStats.appendChild(li);
                    });
                }

            } catch (error) {
                console.error('Error loading dashboard stats:', error);
            }
        }

        // Query execution functions
        function executeQuery(sql, title) {
            try {
                const result = db.exec(sql);
                displayResults(title, result);
            } catch (error) {
                showError(`SQL Error: ${error.message}`);
            }
        }

        function runTopMeetingNames() {
            executeQuery(sqlQueries['top-names'], 'Top 10 Meeting Names');
        }

        function runVirtualMeetings() {
            executeQuery(sqlQueries['virtual'], 'Virtual Meetings');
        }

        function runMeetingsByState() {
            executeQuery(sqlQueries['by-state'], 'Meetings by State/Province');
        }

        function runMorningMeetings() {
            executeQuery(sqlQueries['morning'], 'Morning Meetings (Before 9 AM)');
        }

        function runWeekendMeetings() {
            executeQuery(sqlQueries['weekend'], 'Weekend Meetings');
        }

        function runFormatBreakdown() {
            executeQuery(sqlQueries['formats'], 'Meeting Format Breakdown');
        }

        function runCustomSQL() {
            const sql = document.getElementById('custom-sql').value.trim();
            if (!sql) {
                showError('Please enter a SQL query');
                return;
            }
            executeQuery(sql, 'Custom Query Results');
        }

        function searchMeetings() {
            const query = document.getElementById('search-query').value.trim();
            const city = document.getElementById('search-city').value.trim();
            const state = document.getElementById('search-state').value.trim();
            const day = document.getElementById('search-day').value;
            const venue = document.getElementById('search-venue').value;

            let sql = `SELECT meeting_name, start_time, weekday_tinyint, venue_type,
                             location_street, location_municipality, location_province,
                             virtual_meeting_link, virtual_meeting_additional_info,
                             formats, comments
                      FROM meetings WHERE 1=1`;
            
            if (query) sql += ` AND meeting_name LIKE '%${query}%'`;
            if (city) sql += ` AND location_municipality LIKE '%${city}%'`;
            if (state) sql += ` AND location_province = '${state}'`;
            if (day) sql += ` AND weekday_tinyint = ${day}`;
            if (venue) sql += ` AND venue_type = ${venue}`;
            
            sql += ` ORDER BY weekday_tinyint, start_time LIMIT 200`;

            executeQuery(sql, 'Search Results');
        }

        function showSQL(queryId) {
            if (sqlQueries[queryId]) {
                document.getElementById('custom-sql').value = sqlQueries[queryId];
                document.getElementById('custom-sql').scrollIntoView();
            }
        }

        function clearSQL() {
            document.getElementById('custom-sql').value = '';
        }

        function insertExample() {
            document.getElementById('custom-sql').value = `SELECT name FROM sqlite_master WHERE type='table';`;
        }

        function displayResults(title, sqlResult) {
            document.getElementById('results-title').textContent = title;
            
            if (!sqlResult || !sqlResult[0] || !sqlResult[0].values.length) {
                document.getElementById('results-content').innerHTML = '<div class="alert alert-info">No results found.</div>';
                document.getElementById('results').style.display = 'block';
                document.getElementById('results').scrollIntoView();
                return;
            }

            const columns = sqlResult[0].columns;
            const rows = sqlResult[0].values;
            
            let html = `<div class="alert alert-success">Found ${rows.length} result(s)</div>`;
            html += '<div class="table-container"><table>';
            
            // Header
            html += '<thead><tr>';
            columns.forEach(col => {
                html += `<th>${col.replace(/_/g, ' ').toUpperCase()}</th>`;
            });
            html += '</tr></thead>';
            
            // Body
            html += '<tbody>';
            rows.forEach(row => {
                html += '<tr>';
                row.forEach(cell => {
                    let value = cell || '';
                    if (typeof value === 'string' && value.length > 50) {
                        value = value.substring(0, 47) + '...';
                    }
                    html += `<td>${value}</td>`;
                });
                html += '</tr>';
            });
            html += '</tbody></table></div>';
            
            document.getElementById('results-content').innerHTML = html;
            document.getElementById('results').style.display = 'block';
            document.getElementById('results').scrollIntoView();
        }

        function showError(message) {
            document.getElementById('results-content').innerHTML = `<div class="alert alert-error">${message}</div>`;
            document.getElementById('results').style.display = 'block';
        }

        // Initialize the app when page loads
        window.addEventListener('load', initApp);
    </script>
</body>
</html>
